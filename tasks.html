<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>TimeWise - Tasks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #3B82F6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-tostart { background-color: #E5E7EB; color: #374151; }
        .status-priority { background-color: #FEE2E2; color: #991B1B; }
        .status-wip { background-color: #DBEAFE; color: #1E40AF; }
        .status-completed { background-color: #D1FAE5; color: #065F46; }
        .status-hold { background-color: #FEF3C7; color: #92400E; }
        .status-cancelled { background-color: #F3F4F6; color: #6B7280; }
        .overdue { border-left: 4px solid #EF4444 !important; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 1rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="loading-spinner mx-auto"></div>
            <p class="text-white mt-4" id="loadingText">Processing...</p>
        </div>
    </div>
    <div id="app"></div>

    <script src="config.js"></script>
    <script>
        // State
        let isLoggedIn = false, employeeEmail = '', employeeData = null;
        let assignments = [], employees = [], summary = {};
        let editingTask = null, viewingLog = null;
        let filterStatus = 'all';

        // Session
        function saveSession() { localStorage.setItem('timewise_session', JSON.stringify({ employeeEmail, employeeData, timestamp: Date.now() })); }
        function loadSession() { try { const s = JSON.parse(localStorage.getItem('timewise_session')); if (s && (Date.now() - s.timestamp) < 30*60*1000) return s; localStorage.removeItem('timewise_session'); } catch(e){} return null; }
        function clearSession() { localStorage.removeItem('timewise_session'); }
        function showLoading(t = 'Processing...') { document.getElementById('loadingText').textContent = t; document.getElementById('loadingOverlay').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

        // API
        async function callAPI(action, params = {}) {
            const r = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action, ...params }) });
            const result = await r.json();
            if (!result.success && result.error) throw new Error(result.error);
            return result.data !== undefined ? result.data : result;
        }

        // Formatters
        function formatDate(date) { 
            if (!date) return '-'; 
            const d = new Date(date); 
            if (isNaN(d.getTime())) return date; 
            const m = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; 
            return `${d.getDate().toString().padStart(2,'0')}-${m[d.getMonth()]}-${d.getFullYear()}`; 
        }
        function formatDateTime(date) {
            if (!date) return '-';
            const d = new Date(date);
            if (isNaN(d.getTime())) return date;
            return formatDate(date) + ' ' + d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        }
        function getStatusClass(status) {
            const map = { 'To Start': 'status-tostart', 'Priority': 'status-priority', 'WIP': 'status-wip', 'Completed': 'status-completed', 'Hold': 'status-hold', 'Cancelled': 'status-cancelled' };
            return map[status] || 'status-tostart';
        }
        function isOverdue(task) {
            if (!task.taskData?.['Due Date']) return false;
            const status = task.taskData?.['Type'] || 'To Start';
            if (status === 'Completed' || status === 'Cancelled') return false;
            return new Date(task.taskData['Due Date']) < new Date(new Date().toDateString());
        }
        function getEmployeeName(email) {
            const emp = employees.find(e => e['Employee Email'] === email);
            return emp ? emp['Employee Name'] : email;
        }

        // Login
        async function handleLogin() {
            const input = document.getElementById('emailInput'), statusDiv = document.getElementById('loginStatus'), loginBtn = document.getElementById('loginBtn');
            employeeEmail = input.value.trim().toLowerCase();
            if (!employeeEmail || !employeeEmail.includes('@')) { statusDiv.innerHTML = '<p class="text-red-600 text-sm mt-2">Please enter a valid email</p>'; return; }
            loginBtn.disabled = true; loginBtn.innerHTML = '<span class="inline-block animate-spin mr-2">‚è≥</span> Logging in...';
            try {
                const initData = await callAPI('initTask', { email: employeeEmail });
                employeeData = initData.employee;
                assignments = initData.assignments || [];
                employees = initData.employees || [];
                summary = initData.summary || {};
                isLoggedIn = true; saveSession(); render();
            } catch (error) { loginBtn.disabled = false; loginBtn.innerHTML = 'Login'; statusDiv.innerHTML = `<p class="text-red-600 text-sm mt-2">‚ùå ${error.message}</p>`; }
        }

        async function refreshData() {
            showLoading('Refreshing...');
            try {
                const initData = await callAPI('initTask', { email: employeeEmail });
                assignments = initData.assignments || [];
                employees = initData.employees || [];
                summary = initData.summary || {};
                hideLoading(); render();
            } catch (error) { hideLoading(); alert('Error: ' + error.message); }
        }

        function handleLogout() { clearSession(); isLoggedIn = false; employeeEmail = ''; employeeData = null; assignments = []; render(); }

        // Task Actions
        function handleEditTask(task) { editingTask = JSON.parse(JSON.stringify(task)); render(); }
        function handleCancelEdit() { editingTask = null; render(); }

        async function handleSaveTask() {
            const dueDate = document.getElementById('taskDueDate')?.value || '';
            const executionReady = document.getElementById('taskExecReady')?.value || 'No';
            const assignedToEmail = document.getElementById('taskAssignedTo')?.value || '';
            const type = document.getElementById('taskType')?.value || 'To Start';
            const statusUpdate = document.getElementById('taskStatusUpdate')?.value?.trim() || '';

            if (!statusUpdate) { alert('Please provide a status update'); return; }

            const isHead = editingTask['Assignment Head'] === employeeEmail;
            const currentStatus = editingTask.taskData?.['Type'] || 'To Start';
            
            // Validate: Can't change due date if completed
            if ((currentStatus === 'Completed' || currentStatus === 'Cancelled') && dueDate !== (editingTask.taskData?.['Due Date']?.split('T')[0] || '')) {
                alert('Cannot change due date for completed/cancelled tasks');
                return;
            }

            showLoading('Saving...');
            try {
                await callAPI('updateTask', {
                    task: {
                        assignmentRowId: editingTask['Row ID'],
                        dueDate,
                        executionReady,
                        assignedTo: assignedToEmail ? getEmployeeName(assignedToEmail) : '',
                        assignedToEmail,
                        type,
                        statusUpdate,
                        currentAssignedToEmail: editingTask.taskData?.['Assigned To Email'] || ''
                    },
                    email: employeeEmail,
                    employeeName: employeeData['Employee Name']
                });
                editingTask = null;
                await refreshData();
                alert('Task updated successfully!');
            } catch (error) { hideLoading(); alert('Error: ' + error.message); }
        }

        async function handleViewLog(task) {
            showLoading('Loading history...');
            try {
                const logs = await callAPI('getTaskLog', { assignmentRowId: task['Row ID'] });
                viewingLog = { task, logs: logs || [] };
                hideLoading(); render();
            } catch (error) { hideLoading(); alert('Error: ' + error.message); }
        }

        function handleCloseLog() { viewingLog = null; render(); }

        function setFilter(status) { filterStatus = status; render(); }

        function getFilteredAssignments() {
            if (filterStatus === 'all') return assignments;
            if (filterStatus === 'overdue') return assignments.filter(a => isOverdue(a));
            if (filterStatus === 'nodata') return assignments.filter(a => !a.hasTaskData);
            return assignments.filter(a => (a.taskData?.['Type'] || 'To Start') === filterStatus);
        }

        // Render Login
        function renderLogin() {
            return `<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                    <div class="text-center mb-6"><div class="text-6xl mb-4">üìã</div><h1 class="text-3xl font-bold text-gray-800">TimeWise</h1><p class="text-gray-600 mt-2">Task Management</p></div>
                    <div class="mb-4"><label class="block text-gray-700 font-semibold mb-2">Email Address</label><input type="email" id="emailInput" placeholder="your.email@company.com" class="w-full px-4 py-3 border-2 rounded-xl focus:ring-2 focus:ring-blue-500" onkeypress="if(event.key === 'Enter') handleLogin()" /></div>
                    <button id="loginBtn" onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 font-semibold">Login</button>
                    <div id="loginStatus" class="mt-4"></div>
                    <div class="mt-4 text-center"><a href="home.html" class="text-blue-600 hover:text-blue-800 text-sm">‚Üê Back to Home</a></div>
                </div></div>`;
        }

        // Render Task Card
        function renderTaskCard(task) {
            const td = task.taskData || {};
            const status = td['Type'] || 'To Start';
            const isHead = task['Assignment Head'] === employeeEmail;
            const overdueClass = isOverdue(task) ? 'overdue' : '';
            
            return `<div class="bg-white rounded-xl shadow-md p-4 border-l-4 ${overdueClass}" style="border-left-color: ${isOverdue(task) ? '#EF4444' : '#E5E7EB'}">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <h3 class="font-bold text-lg text-gray-800">${task['Client Name']}</h3>
                        <p class="text-blue-600 font-medium">${task['Task Assigned']}</p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${getStatusClass(status)}">${status}</span>
                        ${isOverdue(task) ? '<span class="text-red-600 text-xs font-bold">üî¥ OVERDUE</span>' : ''}
                        ${task.isAssignedTo ? '<span class="text-xs text-purple-600 font-semibold">üë§ Assigned to you</span>' : ''}
                    </div>
                </div>
                <p class="text-gray-600 text-sm mb-3">${task['Assignment Description'] || '-'}</p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs mb-3">
                    <div class="bg-gray-50 p-2 rounded"><span class="text-gray-500">Head:</span><br><span class="font-semibold">${getEmployeeName(task['Assignment Head'])}</span></div>
                    <div class="bg-gray-50 p-2 rounded"><span class="text-gray-500">Due:</span><br><span class="font-semibold ${isOverdue(task) ? 'text-red-600' : ''}">${formatDate(td['Due Date'])}</span></div>
                    <div class="bg-gray-50 p-2 rounded"><span class="text-gray-500">Assigned To:</span><br><span class="font-semibold">${td['Assigned To'] || '-'}</span></div>
                    <div class="bg-gray-50 p-2 rounded"><span class="text-gray-500">Exec Ready:</span><br><span class="font-semibold">${td['Execution Ready'] === 'Yes' ? '‚úÖ Yes' : '‚ùå No'}</span></div>
                </div>
                ${td['Status Update'] ? `<div class="bg-blue-50 p-2 rounded text-sm mb-3"><span class="text-gray-500">Last Update:</span> ${td['Status Update']}</div>` : ''}
                <div class="flex gap-2">
                    <button onclick='handleEditTask(${JSON.stringify(task).replace(/'/g, "\\'")})' class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold text-sm">üìù Update</button>
                    <button onclick='handleViewLog(${JSON.stringify(task).replace(/'/g, "\\'")})' class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold text-sm">üìú History</button>
                </div>
            </div>`;
        }

        // Render Edit Modal
        function renderEditModal() {
            if (!editingTask) return '';
            const td = editingTask.taskData || {};
            const isHead = editingTask['Assignment Head'] === employeeEmail;
            const currentStatus = td['Type'] || 'To Start';
            const isCompleted = currentStatus === 'Completed' || currentStatus === 'Cancelled';
            const today = new Date().toISOString().split('T')[0];
            const currentDueDate = td['Due Date'] ? (typeof td['Due Date'] === 'string' && td['Due Date'].includes('T') ? td['Due Date'].split('T')[0] : td['Due Date']) : '';

            return `<div class="modal" onclick="if(event.target === this) handleCancelEdit()">
                <div class="modal-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">üìù Update Task</h2>
                        <button onclick="handleCancelEdit()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg mb-4">
                        <p class="font-bold text-blue-800">${editingTask['Client Name']} - ${editingTask['Task Assigned']}</p>
                        <p class="text-sm text-blue-600">${editingTask['Assignment Description'] || ''}</p>
                    </div>
                    ${!isHead ? '<div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg mb-4 text-sm text-yellow-800">‚ö†Ô∏è You are the assignee. You can only update Status and Status Update.</div>' : ''}
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Due Date ${isCompleted ? '(Locked)' : ''}</label>
                                <input type="date" id="taskDueDate" value="${currentDueDate}" ${!isHead || isCompleted ? 'disabled' : ''} min="${today}"
                                    class="w-full px-3 py-2 border rounded-lg ${!isHead || isCompleted ? 'bg-gray-100 cursor-not-allowed' : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Execution Ready?</label>
                                <select id="taskExecReady" ${!isHead ? 'disabled' : ''} class="w-full px-3 py-2 border rounded-lg ${!isHead ? 'bg-gray-100 cursor-not-allowed' : ''}">
                                    <option value="No" ${td['Execution Ready'] !== 'Yes' ? 'selected' : ''}>No</option>
                                    <option value="Yes" ${td['Execution Ready'] === 'Yes' ? 'selected' : ''}>Yes</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Assigned To</label>
                            <select id="taskAssignedTo" ${!isHead ? 'disabled' : ''} class="w-full px-3 py-2 border rounded-lg ${!isHead ? 'bg-gray-100 cursor-not-allowed' : ''}">
                                <option value="">-- Not Assigned --</option>
                                ${employees.map(e => `<option value="${e['Employee Email']}" ${td['Assigned To Email'] === e['Employee Email'] ? 'selected' : ''}>${e['Employee Name']}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Status</label>
                            <select id="taskType" class="w-full px-3 py-2 border rounded-lg">
                                <option value="To Start" ${currentStatus === 'To Start' ? 'selected' : ''}>üìã To Start</option>
                                <option value="Priority" ${currentStatus === 'Priority' ? 'selected' : ''}>üî¥ Priority</option>
                                <option value="WIP" ${currentStatus === 'WIP' ? 'selected' : ''}>üîµ WIP (Work in Progress)</option>
                                <option value="Completed" ${currentStatus === 'Completed' ? 'selected' : ''}>‚úÖ Completed</option>
                                <option value="Hold" ${currentStatus === 'Hold' ? 'selected' : ''}>‚è∏Ô∏è Hold</option>
                                <option value="Cancelled" ${currentStatus === 'Cancelled' ? 'selected' : ''}>‚ùå Cancelled</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Status Update * <span class="font-normal text-gray-500">(What changed?)</span></label>
                            <textarea id="taskStatusUpdate" rows="3" placeholder="Describe the progress or update..." class="w-full px-3 py-2 border rounded-lg"></textarea>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="handleSaveTask()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">üíæ Save Update</button>
                            <button onclick="handleCancelEdit()" class="px-6 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 font-semibold">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // Render Log Modal
        function renderLogModal() {
            if (!viewingLog) return '';
            const task = viewingLog.task;
            const logs = viewingLog.logs || [];

            return `<div class="modal" onclick="if(event.target === this) handleCloseLog()">
                <div class="modal-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">üìú Task History</h2>
                        <button onclick="handleCloseLog()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg mb-4">
                        <p class="font-bold text-blue-800">${task['Client Name']} - ${task['Task Assigned']}</p>
                        <p class="text-sm text-blue-600">${task['Assignment Description'] || ''}</p>
                    </div>
                    ${logs.length === 0 ? `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">üì≠</div>
                            <p>No updates recorded yet</p>
                        </div>
                    ` : `
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${logs.map((log, i) => `
                                <div class="border rounded-lg p-3 ${log.Trail === 'Edited' ? 'bg-gray-100 opacity-60' : 'bg-white'}">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <span class="font-semibold text-gray-800">${log['Employee Name'] || log['Employee Email']}</span>
                                            ${log.Trail === 'Edited' ? '<span class="text-xs text-gray-500 ml-2">(superseded)</span>' : ''}
                                        </div>
                                        <span class="text-xs text-gray-500">${formatDateTime(log.Timestamp)}</span>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs mb-2">
                                        <div><span class="text-gray-500">Status:</span> <span class="font-semibold ${getStatusClass(log.Type)}">${log.Type || '-'}</span></div>
                                        <div><span class="text-gray-500">Due:</span> <span class="font-semibold">${formatDate(log['Due Date'])}</span></div>
                                        <div><span class="text-gray-500">Assigned:</span> <span class="font-semibold">${log['Assigned To'] || '-'}</span></div>
                                    </div>
                                    ${log['Status Update'] ? `<div class="text-sm bg-gray-50 p-2 rounded"><span class="text-gray-500">Update:</span> ${log['Status Update']}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `}
                    <div class="mt-4">
                        <button onclick="handleCloseLog()" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 font-semibold">Close</button>
                    </div>
                </div>
            </div>`;
        }

        // Render App
        function renderApp() {
            const filteredTasks = getFilteredAssignments();
            
            return `<div class="min-h-screen bg-gray-50">
                <div class="bg-blue-600 text-white p-4 shadow-md">
                    <div class="max-w-6xl mx-auto flex justify-between items-center">
                        <div><h1 class="text-2xl font-bold">üìã Task Management</h1><p class="text-blue-100 text-sm">${employeeData['Employee Name']} | ${employeeData['Designation'] || ''}</p></div>
                        <a href="home.html" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded-lg text-sm font-semibold">‚Üê Home</a>
                    </div>
                </div>
                <div class="max-w-6xl mx-auto p-4 space-y-6">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                        <div onclick="setFilter('all')" class="cursor-pointer bg-white rounded-xl shadow-md p-3 text-center hover:shadow-lg transition ${filterStatus === 'all' ? 'ring-2 ring-blue-500' : ''}">
                            <p class="text-2xl font-bold text-gray-800">${summary.total || 0}</p>
                            <p class="text-xs text-gray-500">Total</p>
                        </div>
                        <div onclick="setFilter('To Start')" class="cursor-pointer bg-white rounded-xl shadow-md p-3 text-center hover:shadow-lg transition ${filterStatus === 'To Start' ? 'ring-2 ring-blue-500' : ''}">
                            <p class="text-2xl font-bold text-gray-600">${summary.toStart || 0}</p>
                            <p class="text-xs text-gray-500">To Start</p>
                        </div>
                        <div onclick="setFilter('Priority')" class="cursor-pointer bg-white rounded-xl shadow-md p-3 text-center hover:shadow-lg transition ${filterStatus === 'Priority' ? 'ring-2 ring-blue-500' : ''}">
                            <p class="text-2xl font-bold text-red-600">${summary.priority || 0}</p>
                            <p class="text-xs text-gray-500">Priority</p>
                        </div>
                        <div onclick="setFilter('WIP')" class="cursor-pointer bg-white rounded-xl shadow-md p-3 text-center hover:shadow-lg transition ${filterStatus === 'WIP' ? 'ring-2 ring-blue-500' : ''}">
                            <p class="text-2xl font-bold text-blue-600">${summary.wip || 0}</p>
                            <p class="text-xs text-gray-500">WIP</p>
                        </div>
                        <div onclick="setFilter('Completed')" class="cursor-pointer bg-white rounded-xl shadow-md p-3 text-center hover:shadow-lg transition ${filterStatus === 'Completed' ? 'ring-2 ring-blue-500' : ''}">
                            <p class="text-2xl font-bold text-green-600">${summary.completed || 0}</p>
                            <p class="text-xs text-gray-500">Completed</p>
                        </div>
                        <div onclick="setFilter('overdue')" class="cursor-pointer bg-white rounded-xl shadow-md p-3 text-center hover:shadow-lg transition ${filterStatus === 'overdue' ? 'ring-2 ring-red-500' : ''}">
                            <p class="text-2xl font-bold text-red-600">${summary.overdue || 0}</p>
                            <p class="text-xs text-gray-500">Overdue</p>
                        </div>
                    </div>

                    <!-- Filter Bar -->
                    <div class="flex flex-wrap gap-2 items-center">
                        <span class="text-gray-600 font-semibold">Filter:</span>
                        <button onclick="setFilter('all')" class="px-3 py-1 rounded-full text-sm ${filterStatus === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">All</button>
                        <button onclick="setFilter('nodata')" class="px-3 py-1 rounded-full text-sm ${filterStatus === 'nodata' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">New (${summary.noData || 0})</button>
                        <button onclick="setFilter('Hold')" class="px-3 py-1 rounded-full text-sm ${filterStatus === 'Hold' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">On Hold (${summary.hold || 0})</button>
                        <button onclick="setFilter('Cancelled')" class="px-3 py-1 rounded-full text-sm ${filterStatus === 'Cancelled' ? 'bg-gray-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Cancelled (${summary.cancelled || 0})</button>
                        <button onclick="refreshData()" class="ml-auto px-4 py-1 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200 font-semibold">üîÑ Refresh</button>
                    </div>

                    <!-- Task List -->
                    ${filteredTasks.length === 0 ? `
                        <div class="bg-white rounded-xl shadow-md p-8 text-center text-gray-500">
                            <div class="text-5xl mb-3">üìã</div>
                            <p class="text-lg">No tasks found</p>
                            <p class="text-sm">Tasks will appear here when assignments are created with you as the head</p>
                        </div>
                    ` : `
                        <div class="grid md:grid-cols-2 gap-4">
                            ${filteredTasks.map(task => renderTaskCard(task)).join('')}
                        </div>
                    `}

                    <div class="text-center text-gray-400 text-sm py-4">TimeWise v3.3 | ¬© 2026 DRP & Co. LLP</div>
                </div>
                ${renderEditModal()}
                ${renderLogModal()}
            </div>`;
        }

        function render() { document.getElementById('app').innerHTML = isLoggedIn ? renderApp() : renderLogin(); }

        // Initialize
        async function init() {
            const session = loadSession();
            if (session && session.employeeEmail && session.employeeData) {
                document.getElementById('app').innerHTML = `<div class="min-h-screen bg-gray-50 flex items-center justify-center"><div class="text-center"><div class="loading-spinner mx-auto"></div><p class="mt-4 text-gray-600">Loading tasks...</p></div></div>`;
                try {
                    employeeEmail = session.employeeEmail; employeeData = session.employeeData;
                    const initData = await callAPI('initTask', { email: employeeEmail });
                    assignments = initData.assignments || [];
                    employees = initData.employees || [];
                    summary = initData.summary || {};
                    isLoggedIn = true; saveSession(); render();
                } catch (error) { console.error('Session error:', error); clearSession(); render(); }
            } else { render(); }
        }
        init();
    </script>
</body>
</html>
