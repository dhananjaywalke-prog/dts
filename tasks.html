<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeWise - Tasks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #3B82F6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-tostart { background: #E5E7EB; color: #374151; }
        .status-priority { background: #FEE2E2; color: #991B1B; }
        .status-wip { background: #DBEAFE; color: #1E40AF; }
        .status-completed { background: #D1FAE5; color: #065F46; }
        .status-hold { background: #FEF3C7; color: #92400E; }
        .status-cancelled { background: #F3F4F6; color: #6B7280; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 1rem; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background: #E5E7EB; }
        tr.overdue { background: #FEF2F2 !important; }
        tr:hover { background: #F9FAFB; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center"><div class="loading-spinner mx-auto"></div><p class="text-white mt-4" id="loadingText">Processing...</p></div>
    </div>
    <div id="app"></div>
    <script src="config.js"></script>
    <script>
        let isLoggedIn = false, employeeEmail = '', employeeData = null;
        let tasks = [], employees = [], summary = {};
        let editingTask = null, viewingHistory = null;
        let filterStatus = 'all', searchQuery = '';
        let sortColumn = 'Due Date', sortDirection = 'asc';  // Default: Due Date ascending (nearest first)
        let currentPage = 1, pageSize = 10;
        
        // Status priority for sorting (lower = higher priority)
        const statusPriority = { 'Priority': 1, 'WIP': 2, 'To Start': 3, 'Hold': 4, 'Completed': 5, 'Cancelled': 6 };

        function saveSession() { localStorage.setItem('timewise_session', JSON.stringify({ employeeEmail, employeeData, timestamp: Date.now() })); }
        function loadSession() { try { const s = JSON.parse(localStorage.getItem('timewise_session')); if (s && (Date.now() - s.timestamp) < 30*60*1000) return s; } catch(e){} return null; }
        function clearSession() { localStorage.removeItem('timewise_session'); }
        function showLoading(t = 'Processing...') { document.getElementById('loadingText').textContent = t; document.getElementById('loadingOverlay').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

        async function callAPI(action, params = {}) {
            const r = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action, ...params }) });
            const result = await r.json();
            if (!result.success && result.error) throw new Error(result.error);
            return result.data !== undefined ? result.data : result;
        }

        function formatDate(date) { if (!date) return '-'; const d = new Date(date); if (isNaN(d.getTime())) return date; return d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }); }
        function formatDateTime(date) { if (!date) return '-'; const d = new Date(date); if (isNaN(d.getTime())) return date; return d.toLocaleString('en-IN', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }
        function getStatusClass(s) { return { 'To Start': 'status-tostart', 'Priority': 'status-priority', 'WIP': 'status-wip', 'Completed': 'status-completed', 'Hold': 'status-hold', 'Cancelled': 'status-cancelled' }[s] || 'status-tostart'; }
        function getStatusIcon(s) { return { 'To Start': '‚¨ú', 'Priority': 'üî¥', 'WIP': 'üîµ', 'Completed': '‚úÖ', 'Hold': '‚è∏Ô∏è', 'Cancelled': '‚ùå' }[s] || '‚¨ú'; }
        function isOverdue(t) { if (!t['Due Date']) return false; const s = t['Type'] || 'To Start'; if (s === 'Completed' || s === 'Cancelled') return false; return new Date(t['Due Date']) < new Date(new Date().toDateString()); }

        async function handleLogin() {
            const input = document.getElementById('emailInput'), statusDiv = document.getElementById('loginStatus'), btn = document.getElementById('loginBtn');
            employeeEmail = input.value.trim().toLowerCase();
            if (!employeeEmail || !employeeEmail.includes('@')) { statusDiv.innerHTML = '<p class="text-red-600 text-sm mt-2">Please enter a valid email</p>'; return; }
            btn.disabled = true; btn.innerHTML = '‚è≥ Logging in...';
            try {
                const data = await callAPI('initTask', { email: employeeEmail });
                employeeData = data.employee; tasks = data.tasks || []; employees = data.employees || []; summary = data.summary || {};
                isLoggedIn = true; saveSession(); render();
            } catch (e) { btn.disabled = false; btn.innerHTML = 'Login'; statusDiv.innerHTML = `<p class="text-red-600 text-sm mt-2">‚ùå ${e.message}</p>`; }
        }

        async function refreshData() {
            showLoading('Refreshing...');
            try {
                const data = await callAPI('initTask', { email: employeeEmail });
                tasks = data.tasks || []; employees = data.employees || []; summary = data.summary || {};
                hideLoading(); render();
            } catch (e) { hideLoading(); alert('Error: ' + e.message); }
        }

        function getFilteredTasks() {
            let f = [...tasks];
            if (filterStatus === 'overdue') f = f.filter(t => isOverdue(t));
            else if (filterStatus !== 'all') f = f.filter(t => (t['Type'] || 'To Start') === filterStatus);
            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                f = f.filter(t => (t['Client Name']||'').toLowerCase().includes(q) || (t['Task Assigned']||'').toLowerCase().includes(q) || (t['Assignment Description']||'').toLowerCase().includes(q) || (t['Assigned To']||'').toLowerCase().includes(q));
            }
            // Multi-level sorting: Due Date ‚Üí Status ‚Üí Client Name
            f.sort((a, b) => {
                // If user selected a specific column, use that first
                if (sortColumn === 'Due Date') {
                    // Due date: nulls last, then ascending (nearest first)
                    const dA = a['Due Date'] ? new Date(a['Due Date']).getTime() : (sortDirection === 'asc' ? Infinity : -Infinity);
                    const dB = b['Due Date'] ? new Date(b['Due Date']).getTime() : (sortDirection === 'asc' ? Infinity : -Infinity);
                    if (dA !== dB) return sortDirection === 'asc' ? dA - dB : dB - dA;
                    
                    // Then by status priority
                    const sA = statusPriority[a['Type'] || 'To Start'] || 99;
                    const sB = statusPriority[b['Type'] || 'To Start'] || 99;
                    if (sA !== sB) return sA - sB;
                    
                    // Then by client name
                    return (a['Client Name'] || '').localeCompare(b['Client Name'] || '');
                } else if (sortColumn === 'Type') {
                    // Sort by status priority
                    const sA = statusPriority[a['Type'] || 'To Start'] || 99;
                    const sB = statusPriority[b['Type'] || 'To Start'] || 99;
                    const result = sA - sB;
                    return sortDirection === 'asc' ? result : -result;
                } else {
                    // Other columns: simple sort
                    let vA = a[sortColumn] || '', vB = b[sortColumn] || '';
                    if (sortColumn === 'Last Updated On') { 
                        vA = vA ? new Date(vA).getTime() : 0; 
                        vB = vB ? new Date(vB).getTime() : 0; 
                    } else { 
                        vA = String(vA).toLowerCase(); 
                        vB = String(vB).toLowerCase(); 
                    }
                    if (vA < vB) return sortDirection === 'asc' ? -1 : 1;
                    if (vA > vB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                }
            });
            return f;
        }

        function getPaginatedTasks() {
            const f = getFilteredTasks(), start = (currentPage - 1) * pageSize;
            return { tasks: f.slice(start, start + pageSize), total: f.length, totalPages: Math.ceil(f.length / pageSize) || 1 };
        }

        function handleSort(col) { if (sortColumn === col) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'; else { sortColumn = col; sortDirection = 'asc'; } currentPage = 1; render(); }
        function handleFilter(s) { filterStatus = s; currentPage = 1; render(); }
        let searchTimeout = null;
        function handleSearch(e) { 
            const value = e.target.value;
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchQuery = value; 
                currentPage = 1; 
                render();
                // Restore focus and cursor position
                const searchBox = document.getElementById('searchBox');
                if (searchBox) {
                    searchBox.focus();
                    searchBox.setSelectionRange(searchBox.value.length, searchBox.value.length);
                }
            }, 300); // 300ms debounce
        }
        function handlePageChange(p) { currentPage = p; render(); }

        function exportToExcel() {
            const f = getFilteredTasks();
            const data = f.map(t => ({ Client: t['Client Name']||'', Task: t['Task Assigned']||'', Description: t['Assignment Description']||'', Head: t['Assignment Head']||'', 'Due Date': formatDate(t['Due Date']), 'Assigned To': t['Assigned To']||'', 'Exec Ready': t['Execution Ready']||'No', Status: t['Type']||'To Start', 'Status Update': t['Status Update']||'', 'Last Updated': formatDateTime(t['Last Updated On']) }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Tasks');
            XLSX.writeFile(wb, `Tasks_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        async function handleEditTask(taskIndex) { 
            const t = getPaginatedTasks().tasks[taskIndex];
            if (t) {
                editingTask = JSON.parse(JSON.stringify(t));
                
                // If user is head, fetch assignee updates
                if (editingTask.isHead) {
                    try {
                        const updates = await callAPI('getAssigneeUpdates', { assignmentRowId: editingTask['Row ID'] });
                        editingTask.assigneeUpdates = updates || [];
                    } catch (e) {
                        console.error('Failed to fetch assignee updates:', e);
                        editingTask.assigneeUpdates = [];
                    }
                }
                
                render(); 
            }
        }
        function handleCancelEdit() { editingTask = null; render(); }

        async function handleSaveTask() {
            const dueDate = document.getElementById('taskDueDate')?.value || '';
            const executionReady = document.getElementById('taskExecReady')?.value || 'No';
            const type = document.getElementById('taskType')?.value || 'To Start';
            const statusUpdate = document.getElementById('taskStatusUpdate')?.value?.trim() || '';
            
            if (!statusUpdate) { alert('Please provide a status update'); return; }
            
            // Get selected assignees (multi-select checkboxes)
            let assignedToEmails = '';
            let assignedToNames = '';
            
            if (editingTask.isHead) {
                const checkboxes = document.querySelectorAll('.assignee-checkbox:checked');
                const emails = [], names = [];
                checkboxes.forEach(cb => {
                    emails.push(cb.value);
                    names.push(cb.dataset.name);
                });
                assignedToEmails = emails.join(', ');
                assignedToNames = names.join(', ');
            } else {
                // Assignee can't change assignees
                assignedToEmails = editingTask['Assigned To Email'] || '';
                assignedToNames = editingTask['Assigned To'] || '';
            }
            
            // Debug: Show what we're sending
            console.log('Saving task:', {
                rowId: editingTask['Row ID'],
                client: editingTask['Client Name'],
                head: editingTask['Assignment Head'],
                isHead: editingTask.isHead,
                assignees: assignedToNames
            });
            
            showLoading('Saving...');
            try {
                await callAPI('updateTask', { 
                    task: { 
                        rowId: editingTask['Row ID'], 
                        dueDate, 
                        executionReady, 
                        assignedTo: assignedToNames, 
                        assignedToEmail: assignedToEmails, 
                        type, 
                        statusUpdate 
                    }, 
                    email: employeeEmail, 
                    employeeName: employeeData['Employee Name'] 
                });
                editingTask = null; 
                await refreshData(); 
                alert('Task updated successfully!');
            } catch (e) { hideLoading(); alert('Error: ' + e.message); }
        }

        async function handleViewHistory(taskIndex) {
            const t = getPaginatedTasks().tasks[taskIndex];
            if (!t) return;
            showLoading('Loading history...');
            try {
                const h = await callAPI('getTaskHistory', { assignmentRowId: t['Row ID'] });
                viewingHistory = { task: t, history: h || [] }; hideLoading(); render();
            } catch (e) { hideLoading(); alert('Error: ' + e.message); }
        }
        function handleCloseHistory() { viewingHistory = null; render(); }

        function renderLogin() {
            return `<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                    <div class="text-center mb-6"><div class="text-6xl mb-4">üìã</div><h1 class="text-3xl font-bold text-gray-800">TimeWise</h1><p class="text-gray-600 mt-2">Task Management</p></div>
                    <div class="mb-4"><label class="block text-gray-700 font-semibold mb-2">Email Address</label><input type="email" id="emailInput" placeholder="your.email@company.com" class="w-full px-4 py-3 border-2 rounded-xl" onkeypress="if(event.key==='Enter')handleLogin()" /></div>
                    <button id="loginBtn" onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 font-semibold">Login</button>
                    <div id="loginStatus" class="mt-4"></div>
                    <div class="mt-4 text-center"><a href="home.html" class="text-blue-600 hover:text-blue-800 text-sm">‚Üê Back to Home</a></div>
                </div></div>`;
        }

        function renderEditModal() {
            if (!editingTask) return '';
            const isHead = editingTask.isHead === true;
            const status = editingTask['Type'] || 'To Start';
            const isLocked = status === 'Completed' || status === 'Cancelled';
            const today = new Date().toISOString().split('T')[0];
            let dueVal = '';
            if (editingTask['Due Date']) { try { dueVal = new Date(editingTask['Due Date']).toISOString().split('T')[0]; } catch(e){} }
            
            // Parse current assignees (comma-separated)
            const currentAssigneeEmails = (editingTask['Assigned To Email'] || '').split(',').map(e => e.trim()).filter(e => e);
            
            return `<div class="modal" onclick="if(event.target===this)handleCancelEdit()">
                <div class="modal-content p-6">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">üìù Update Task</h2><button onclick="handleCancelEdit()" class="text-2xl text-gray-500">&times;</button></div>
                    <div class="bg-blue-50 p-3 rounded-lg mb-4">
                        <p class="font-bold text-blue-800">${editingTask['Client Name']} - ${editingTask['Task Assigned']}</p>
                        <p class="text-sm text-blue-600">${editingTask['Assignment Description']||''}</p>
                        <p class="text-xs text-gray-500 mt-1">Head: ${editingTask['Assignment Head']}</p>
                    </div>
                    ${!isHead ? '<div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg mb-4 text-sm text-yellow-800">‚ö†Ô∏è You are an assignee. You can only update your Status and Status Update.</div>' : ''}
                    
                    ${isHead && editingTask.assigneeUpdates && editingTask.assigneeUpdates.length > 0 ? `
                    <div class="bg-gray-50 p-3 rounded-lg mb-4">
                        <p class="font-semibold text-gray-700 mb-2">üë• Assignee Updates:</p>
                        <div class="space-y-2 max-h-32 overflow-y-auto">
                            ${editingTask.assigneeUpdates.map(u => `
                                <div class="flex items-center justify-between text-sm bg-white p-2 rounded border">
                                    <span class="font-medium">${u['Updated By Name']}</span>
                                    <span class="px-2 py-0.5 rounded text-xs ${getStatusClass(u['Type'] || 'To Start')}">${u['Type'] || 'To Start'}</span>
                                    <span class="text-gray-500 text-xs max-w-xs truncate" title="${u['Status Update'] || ''}">${u['Status Update'] || '-'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-semibold mb-1">Due Date</label><input type="date" id="taskDueDate" value="${dueVal}" ${!isHead||isLocked?'disabled':''} class="w-full px-3 py-2 border rounded-lg ${!isHead||isLocked?'bg-gray-100':''}"></div>
                            <div><label class="block text-sm font-semibold mb-1">Execution Ready?</label><select id="taskExecReady" ${!isHead?'disabled':''} class="w-full px-3 py-2 border rounded-lg ${!isHead?'bg-gray-100':''}"><option value="No" ${editingTask['Execution Ready']!=='Yes'?'selected':''}>No</option><option value="Yes" ${editingTask['Execution Ready']==='Yes'?'selected':''}>Yes</option></select></div>
                        </div>
                        ${isHead ? `
                        <div>
                            <label class="block text-sm font-semibold mb-1">Assigned To (select multiple)</label>
                            <div class="border rounded-lg p-2 max-h-40 overflow-y-auto bg-white">
                                ${employees.map(e => `
                                    <label class="flex items-center p-1 hover:bg-gray-50 cursor-pointer">
                                        <input type="checkbox" class="assignee-checkbox mr-2" value="${e.email}" data-name="${e.name}" ${currentAssigneeEmails.includes(e.email) ? 'checked' : ''}>
                                        <span class="text-sm">${e.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        <div><label class="block text-sm font-semibold mb-1">Overall Status (set by Head)</label><select id="taskType" ${!isHead?'disabled':''} class="w-full px-3 py-2 border rounded-lg ${!isHead?'bg-gray-100':''}"><option value="To Start" ${status==='To Start'?'selected':''}>‚¨ú To Start</option><option value="Priority" ${status==='Priority'?'selected':''}>üî¥ Priority</option><option value="WIP" ${status==='WIP'?'selected':''}>üîµ WIP</option><option value="Completed" ${status==='Completed'?'selected':''}>‚úÖ Completed</option><option value="Hold" ${status==='Hold'?'selected':''}>‚è∏Ô∏è Hold</option><option value="Cancelled" ${status==='Cancelled'?'selected':''}>‚ùå Cancelled</option></select></div>
                        <div><label class="block text-sm font-semibold mb-1">Status Update *</label><textarea id="taskStatusUpdate" rows="3" placeholder="Describe the progress..." class="w-full px-3 py-2 border rounded-lg"></textarea></div>
                        <div class="flex gap-2"><button onclick="handleSaveTask()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold">üíæ Save</button><button onclick="handleCancelEdit()" class="px-6 bg-gray-500 text-white py-3 rounded-lg font-semibold">Cancel</button></div>
                    </div>
                </div></div>`;
        }

        function renderHistoryModal() {
            if (!viewingHistory) return '';
            const t = viewingHistory.task, h = viewingHistory.history || [];
            return `<div class="modal" onclick="if(event.target===this)handleCloseHistory()">
                <div class="modal-content p-6">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">üìú Task History</h2><button onclick="handleCloseHistory()" class="text-2xl text-gray-500">&times;</button></div>
                    <div class="bg-blue-50 p-3 rounded-lg mb-4"><p class="font-bold text-blue-800">${t['Client Name']} - ${t['Task Assigned']}</p><p class="text-sm text-blue-600">${t['Assignment Description']||''}</p></div>
                    ${h.length===0?'<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">üì≠</div><p>No updates yet</p></div>':`
                    <div class="space-y-3 max-h-96 overflow-y-auto">${h.map(x=>`<div class="border rounded-lg p-3 ${x.Trail==='Edited'?'bg-gray-50 opacity-70':''}">
                        <div class="flex justify-between items-start mb-2"><span class="font-semibold">${x['Updated By Name']||x['Updated By Email']||'-'}</span><div class="text-right"><span class="text-xs text-gray-500">${formatDateTime(x.Timestamp)}</span>${x.Trail==='Edited'?'<span class="block text-xs text-orange-500">Superseded</span>':''}</div></div>
                        <div class="grid grid-cols-3 gap-2 text-xs mb-2"><div><span class="text-gray-500">Status:</span> ${getStatusIcon(x.Type)} ${x.Type||'-'}</div><div><span class="text-gray-500">Due:</span> ${formatDate(x['Due Date'])}</div><div><span class="text-gray-500">Assigned:</span> ${x['Assigned To']||'-'}</div></div>
                        ${x['Status Update']?`<div class="text-sm bg-gray-50 p-2 rounded">${x['Status Update']}</div>`:''}
                    </div>`).join('')}</div>`}
                    <div class="mt-4"><button onclick="handleCloseHistory()" class="w-full bg-gray-200 py-2 rounded-lg font-semibold">Close</button></div>
                </div></div>`;
        }

        function renderTable() {
            const { tasks: pt, total, totalPages } = getPaginatedTasks();
            if (pt.length === 0) return `<div class="bg-white rounded-xl shadow p-8 text-center text-gray-500"><div class="text-5xl mb-3">üìã</div><p class="text-lg">No tasks found</p></div>`;
            const cols = [['Client Name','Client',1],['Task Assigned','Task',1],['Assignment Description','Description',0],['Due Date','Due Date',1],['Assigned To','Assigned To',1],['Type','Status',1]];
            return `<div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="overflow-x-auto"><table class="w-full text-sm">
                    <thead class="bg-gray-100"><tr>
                        ${cols.map(([k,l,s])=>`<th class="px-4 py-3 text-left font-semibold ${s?'sortable cursor-pointer':''}" ${s?`onclick="handleSort('${k}')"`:''}>
                            ${l} ${s&&sortColumn===k?(sortDirection==='asc'?'‚ñ≤':'‚ñº'):''}
                        </th>`).join('')}
                        <th class="px-4 py-3 text-left font-semibold">Actions</th>
                    </tr></thead>
                    <tbody class="divide-y">${pt.map((t,idx)=>{
                        const s=t['Type']||'To Start', od=isOverdue(t);
                        return `<tr class="${od?'overdue':''}">
                            <td class="px-4 py-3 font-medium">${t['Client Name']||'-'}</td>
                            <td class="px-4 py-3 text-blue-600">${t['Task Assigned']||'-'}</td>
                            <td class="px-4 py-3 text-gray-600 max-w-xs truncate" title="${(t['Assignment Description']||'').replace(/"/g, '&quot;')}">${t['Assignment Description']||'-'}</td>
                            <td class="px-4 py-3 whitespace-nowrap ${od?'text-red-600 font-bold':''}">${formatDate(t['Due Date'])}${od?' üî¥':''}</td>
                            <td class="px-4 py-3">${t['Assigned To']||'-'}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-semibold ${getStatusClass(s)}">${getStatusIcon(s)} ${s}</span></td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <button onclick="handleEditTask(${idx})" class="text-blue-600 font-semibold mr-2">‚úèÔ∏è</button>
                                <button onclick="handleViewHistory(${idx})" class="text-gray-600 font-semibold">üìú</button>
                            </td>
                        </tr>`;
                    }).join('')}</tbody>
                </table></div>
                <div class="px-4 py-3 bg-gray-50 border-t flex flex-wrap justify-between items-center gap-2">
                    <span class="text-sm text-gray-600">Showing ${(currentPage-1)*pageSize+1}-${Math.min(currentPage*pageSize,total)} of ${total}</span>
                    <div class="flex gap-1">
                        <button onclick="handlePageChange(1)" ${currentPage===1?'disabled':''} class="px-3 py-1 rounded border ${currentPage===1?'bg-gray-100 text-gray-400':'bg-white hover:bg-gray-100'}">¬´</button>
                        <button onclick="handlePageChange(${currentPage-1})" ${currentPage===1?'disabled':''} class="px-3 py-1 rounded border ${currentPage===1?'bg-gray-100 text-gray-400':'bg-white hover:bg-gray-100'}">‚Äπ</button>
                        ${Array.from({length:Math.min(5,totalPages)},(_,i)=>{let p;if(totalPages<=5)p=i+1;else if(currentPage<=3)p=i+1;else if(currentPage>=totalPages-2)p=totalPages-4+i;else p=currentPage-2+i;return`<button onclick="handlePageChange(${p})" class="px-3 py-1 rounded border ${p===currentPage?'bg-blue-600 text-white':'bg-white hover:bg-gray-100'}">${p}</button>`;}).join('')}
                        <button onclick="handlePageChange(${currentPage+1})" ${currentPage===totalPages?'disabled':''} class="px-3 py-1 rounded border ${currentPage===totalPages?'bg-gray-100 text-gray-400':'bg-white hover:bg-gray-100'}">‚Ä∫</button>
                        <button onclick="handlePageChange(${totalPages})" ${currentPage===totalPages?'disabled':''} class="px-3 py-1 rounded border ${currentPage===totalPages?'bg-gray-100 text-gray-400':'bg-white hover:bg-gray-100'}">¬ª</button>
                    </div>
                </div>
            </div>`;
        }

        function renderApp() {
            return `<div class="min-h-screen bg-gray-50">
                <div class="bg-blue-600 text-white p-4 shadow-md"><div class="max-w-7xl mx-auto flex justify-between items-center">
                    <div><h1 class="text-2xl font-bold">üìã Task Management</h1><p class="text-blue-100 text-sm">${employeeData['Employee Name']}</p></div>
                    <a href="home.html" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded-lg text-sm font-semibold">‚Üê Home</a>
                </div></div>
                <div class="max-w-7xl mx-auto p-4 space-y-4">
                    <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3">
                        ${[['all','Total',summary.total||0,'gray'],['To Start','To Start',summary.toStart||0,'gray'],['Priority','Priority',summary.priority||0,'red'],['WIP','WIP',summary.wip||0,'blue'],['Completed','Done',summary.completed||0,'green'],['Hold','Hold',summary.hold||0,'yellow'],['overdue','Overdue',summary.overdue||0,'red']].map(([f,l,v,c])=>`
                        <div onclick="handleFilter('${f}')" class="cursor-pointer bg-white rounded-xl shadow p-3 text-center hover:shadow-lg ${filterStatus===f?'ring-2 ring-blue-500':''}">
                            <p class="text-2xl font-bold text-${c}-600">${v}</p><p class="text-xs text-gray-500">${l}</p>
                        </div>`).join('')}
                    </div>
                    <div class="bg-white rounded-xl shadow p-4 flex flex-wrap gap-3 items-center justify-between">
                        <div class="flex flex-wrap gap-2 items-center">
                            <select onchange="handleFilter(this.value)" class="px-3 py-1 border rounded-lg text-sm">
                                <option value="all" ${filterStatus==='all'?'selected':''}>All Status</option>
                                <option value="To Start" ${filterStatus==='To Start'?'selected':''}>To Start</option>
                                <option value="Priority" ${filterStatus==='Priority'?'selected':''}>Priority</option>
                                <option value="WIP" ${filterStatus==='WIP'?'selected':''}>WIP</option>
                                <option value="Completed" ${filterStatus==='Completed'?'selected':''}>Completed</option>
                                <option value="Hold" ${filterStatus==='Hold'?'selected':''}>Hold</option>
                                <option value="Cancelled" ${filterStatus==='Cancelled'?'selected':''}>Cancelled</option>
                                <option value="overdue" ${filterStatus==='overdue'?'selected':''}>‚ö†Ô∏è Overdue</option>
                            </select>
                            <input type="text" id="searchBox" placeholder="üîç Search..." value="${searchQuery}" oninput="handleSearch(event)" class="px-3 py-1 border rounded-lg text-sm w-48">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="exportToExcel()" class="px-4 py-1 bg-green-600 text-white rounded-lg text-sm font-semibold">üì• Export</button>
                            <button onclick="refreshData()" class="px-4 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-semibold">üîÑ Refresh</button>
                        </div>
                    </div>
                    ${renderTable()}
                    <div class="text-center text-gray-400 text-sm py-4">TimeWise v3.4</div>
                </div>
                ${renderEditModal()}${renderHistoryModal()}
            </div>`;
        }

        function render() { document.getElementById('app').innerHTML = isLoggedIn ? renderApp() : renderLogin(); }

        async function init() {
            const s = loadSession();
            if (s && s.employeeEmail && s.employeeData) {
                document.getElementById('app').innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="loading-spinner"></div></div>';
                try {
                    employeeEmail = s.employeeEmail; employeeData = s.employeeData;
                    const data = await callAPI('initTask', { email: employeeEmail });
                    tasks = data.tasks || []; employees = data.employees || []; summary = data.summary || {};
                    isLoggedIn = true; saveSession(); render();
                } catch (e) { clearSession(); render(); }
            } else { render(); }
        }
        init();
    </script>
</body>
</html>
